<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

  <meta name="viewport" content="width=device-width,initial-scale=1.0">

  <title>To Boldly Monitor What No One Has Monitored Before &ndash; tobias.is</title>
  <meta name="description" content="Blog of Tobias Baldauf, web performance evangelist, perfmatters engineer at Trivago, father, veggy, hiker, music lover and forever curious geek.">
  <link rel="alternate" type="application/rss+xml" title="tobias.is blog" href="/feed/index.xml">

  <style type="text/css">*,:after,:before{margin:0;padding:0;border:0;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}ol,ul{list-style:none}img{display:block;max-width:100%;border-radius:3px}a{color:#196dff;text-decoration:none;transition:color .3s,background .3s,border .3s}a:hover{color:#ffab19}.cf:after{content:"";display:table;clear:both}@font-face{font-family:'Source Sans Pro';src:local('Source Sans Pro Light'),local('SourceSansPro-Light'),url(/assets/fonts/sourcesanspro-light.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD;font-display:swap;font-weight:300;font-style:normal}html{height:100%;font-family:Source Sans Pro,sans-serif;-webkit-text-size-adjust:100%;-moz-text-size-adjust:100%;-ms-text-size-adjust:100%}body{margin:0 auto;font-size:1.25rem;line-height:1.5rem;padding:1.5em;max-width:50em;background:#fff;color:#444546}.hidden{display:none}.header{border-bottom:2px solid #ffab19;margin-bottom:1.5em}.logo{display:block;margin-bottom:1.5em}.menu a{display:block;color:#c11515}.menu a:hover{color:#9e9e9e;text-decoration:none}.menu .active{color:#ffab19}.menu>li{position:relative}.menu>li>a{padding:.75em 0;border-top:1px solid #ddd;font-weight:700}h1{font-size:3.375rem;line-height:5.063rem;font-weight:700;margin-bottom:.5em}h2{font-size:3.375rem;line-height:5.063rem;font-weight:400;margin-bottom:.5em;color:#ffab19}h3{font-size:2.25rem;line-height:3.375rem;font-weight:400;margin-bottom:.5em}h1 a,h2 a,h3 a{color:inherit;border:0!important}.main{padding-bottom:1.5em;border-bottom:2px solid #ffab19;font-size:1.5rem;line-height:2.25rem}.main hr{margin:3em 0;height:2px;background:#ddd}.main figure,.main ol,.main p,.main ul{margin-bottom:1.5em}.main .blogteaser{margin-bottom:3em}.video{float:none;clear:both;width:100%;position:relative;padding-bottom:56.45%;padding-top:25px;height:0}.video iframe{position:absolute;top:0;left:0;width:100%;height:100%}.floated_left{float:left;width:28%;margin-right:1.5em}.floated_left iframe{width:100%;border-radius:3px}.main blockquote{background-color:#f9f9f9;border-left:2px solid #196dff;margin:1.5em 0 1.5em;padding:1em 1.5em .1em 2.5em;position:relative;border-radius:3px}.main blockquote cite{font-size:.75rem}.main blockquote:after,.main blockquote:before{color:#196dff;font-size:5em;position:absolute;line-height:.1em}.main blockquote:before{content:"\201C";left:5px;top:.6em}.main blockquote:after{content:"\201D";right:3px;bottom:0}.main blockquote p{font-size:1rem;font-style:italic}.e-content li,.main.text li{margin:0 0 1.5em 1em;list-style:disc none outside}.e-content li ul li,.main.text li ul li{margin:1.5em 0 1.5em 1em;list-style:circle none outside;font-size:1.25rem}.main h3{clear:both}.main a{border-bottom:2px solid #ddd}.main a:hover{border-color:#444546}.rainbowtext:before{content:"\01F308";color:#000}.rainbowtext{background-image:-webkit-gradient(linear,left top,right top,color-stop(0,#f22),color-stop(.15,#f2f),color-stop(.3,#22f),color-stop(.45,#2ff),color-stop(.6,#2f2),color-stop(.75,#2f2),color-stop(.9,#ff2),color-stop(1,#f22));background-image:gradient(linear,left top,right top,color-stop(0,#f22),color-stop(.15,#f2f),color-stop(.3,#22f),color-stop(.45,#2ff),color-stop(.6,#2f2),color-stop(.75,#2f2),color-stop(.9,#ff2),color-stop(1,#f22));color:transparent;-webkit-background-clip:text;background-clip:text;-webkit-box-decoration-break:clone;box-decoration-break:clone}.rainbowtext:after{content:"\01F308";color:#000;display:inline-block;-moz-transform:scale(-1,1);-webkit-transform:scale(-1,1);-o-transform:scale(-1,1);-ms-transform:scale(-1,1);transform:scale(-1,1)}.teaser{list-style:none}.teaser li{margin-bottom:1.5em}.teaser li img{float:left;width:30%;margin:.4em 3% 0 0}.teaser li p{float:left;width:66.6%}.nextprev{padding:1em 0}.nextprev a{border:0}.nextprev .prev{float:left}.nextprev .next{float:right}.footer{padding:1em 0 6em;font-size:1rem}.colophon{float:left;text-transform:lowercase}@media screen and (min-width:40em){body{padding:3em}.logo{float:left}.menu{float:right;margin:1em -1em 0 0}.menu>li{float:left}.menu>li>a{padding:.75em 1em;border:0}}@media screen and (max-width:40em){html{font-size:66%}.floated_left,.teaser li img{float:none;width:100%;margin:0 0 1.5em 0}.teaser li p{float:none;width:100%}}</style>

  <link href="data:image/x-icon;base64,AAABAAEAEBAQAAEABAAoAQAAFgAAACgAAAAQAAAAIAAAAAEABAAAAAAAgAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAA/20ZABUVwQAZq/8Anp6eAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAREREQAIiIiJERERAAiIiIkREREACIiIiREREQAIiIiJERBEQAzMiIkREERADMyIiREQREAMzIiIAAAAAAAAAAAAAAAAAAAAAMzMiIAREEREzMyIgBEQRETMzIiAERBERMzMzMAEREREzMzMwARERETMzMzABERERMzMzMAEREREBgAAAAYAAAAGAAAABgAAAAYAAAAGAAAABgAAA//8AAP//AAABgAAAAYAAAAGAAAABgAAAAYAAAAGAAAABgAAA" rel="icon" type="image/x-icon">

</head>
<body>

  <header class="header cf" role="banner">
    <a class="logo" href="/">
      <h1>tobias.is</h1>
    </a>
    <nav role="navigation">

  <ul class="menu cf">
        <li>
      <a  class="active" href="/blogging">Blogging</a>
    </li>
        <li>
      <a  href="/speaking">Speaking</a>
    </li>
        <li>
      <a  href="/about">About</a>
    </li>
      </ul>

</nav>  </header>
  <main class="main h-entry" role="main">

    <h1 class="p-name">To Boldly Monitor What No One Has Monitored Before</h1>

    <div class="text e-content">
      <p>In the <a href="http://calendar.perfplanet.com/2012/using-nginx-php-fpmapc-and-varnish-to-make-wordpress-websites-fly/">Performance Advent Calendar I described</a> how to setup a high performance webserver. As a follow-up, let's look into monitoring this setup to automagically restart unresponsive services such as NGINX, PHP5-FPM and Varnish to minimize downtime.</p>
<p>We'll be <a href="http://mmonit.com/monit/">using Monit on Debian</a> because of its easy syntax. Go ahead and install Monit using your favorite package management tool.</p>
<p>After successful installation, Monit will tell you that you will need to configure it and then enable it to begin monitoring. Let's do that now: open /etc/monit/monitrc and configure it like this:</p>
<script src="https://gist.github.com/4286696.js?file=monitrc"></script>
<p>The nifty bits are how to check for service health: for <a href="http://www.nginx.org/">NGINX</a>, we can simply check to get a static file on port 8080, and for <a href="http://en.wikipedia.org/wiki/Varnish_%28software%29">Varnish</a> on port 80. However, checking for the actual health of PHP can be tricky.</p>
<p>To monitor the stack's capacity of processing PHP code, we'll enable PHP-FPM's ping path: in your /etc/php5/fpm/pool.d/www.conf uncomment the line ping.path = /ping.</p>
<p>Next, configure NGINX so that it knows how to handle the new /ping location:</p>
<script src="https://gist.github.com/4286696.js?file=yourdomain.tld"></script>
<p>Now, Monit can successfully request '/ping' as long as PHP is up &amp; running.</p>
<p>If any of the monitored services becomes unavailable, Monit will restart it. Group settings ensure a cascade of NGINX =&gt; PHP-FPM =&gt; Varnish. If a service becomes unresponsive too often, you will be notified by email.</p>
                      <figure>
          <img src="/content/1-blogging/2-to-boldly-monitor-what-no-one-has-monitored-before/monitoring.jpg" alt="To Boldly Monitor What No One Has Monitored Before">
        </figure>
              
    </div>

    <nav class="nextprev cf" role="navigation">
            <a class="prev" href="/blogging/cross-browser-css-technique-for-svg-sprites-with-png-fallback">&larr; previous</a>
                  <a class="next" href="/blogging/progressive-jpeg-performance-optimization">next &rarr;</a>
          </nav>

  </main>

  <footer class="footer cf" role="contentinfo">

    <div class="colophon">
  		<a class="email" title="Contact me via email" href="mailto:kontakt@tobias-baldauf.de">kontakt@tobias-baldauf.de</a>
  		&nbsp;&#124;&nbsp;
  		<a title="Let's talk on Mastodon" href="//mastodon.social/@tbaldauf/" rel="me">Mastodon</a>
  		&nbsp;&#124;&nbsp;
  		<a title="Read the slides of my talks on Speakerdeck" href="//speakerdeck.com/tbaldauf/" rel="me">Slides</a>
  		&nbsp;&#124;&nbsp;
      <a title="Collaborate with me on Github" href="http://github.com/technopagan/" rel="me">GitHub</a>
      &nbsp;&#124;&nbsp;
  		<a title="Get updates on new blog posts" href="/feed/index.xml" rel="me">Feed</a>
    </div>

  </footer>

</body>
</html>